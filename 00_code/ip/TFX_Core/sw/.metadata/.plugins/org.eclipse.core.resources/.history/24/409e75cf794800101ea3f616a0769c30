#include "xparameters.h"
#include "xscugic.h"

#include "FreeRTOS.h"
#include "semphr.h"

#define INTC_DEVICE_ID  XPAR_PS7_SCUGIC_0_DEVICE_ID

#define CWT_DONE_INTR XPAR_FABRIC_TFX_CORE_0_CWT_DONE_INTR

SemaphoreHandle_t CwtDoneSemaphore;

static void CwtDoneHandler()
{
	BaseType_t xHigherPriorityTaskWoken = pdFALSE;

	if ( xSemaphoreGiveFromISR( CwtDoneSemaphore, &xHigherPriorityTaskWoken ) != pdFALSE) {
		portYIELD_FROM_ISR( xHigherPriorityTaskWoken );
	}
}


int SetupInterruptSystem(XScuGic *IntcInstancePtr)
{
	CwtDoneSemaphore = xSemaphoreCreateBinary();
	if ( CwtDoneSemaphore == NULL ) {
		xil_printf("Failed to create CwtDone Semaphore!\n\rAborting...\n\r");
		return XST_FAILURE;
	}

	// Register interrupt handler using FreeRTOS-aware function
	xPortInstallInterruptHandler(CWT_DONE_INTR, CwtDoneHandler, NULL);

	// Enable the interrupt line
	vPortEnableInterrupt(CWT_DONE_INTR);

	return XST_SUCCESS;
}

