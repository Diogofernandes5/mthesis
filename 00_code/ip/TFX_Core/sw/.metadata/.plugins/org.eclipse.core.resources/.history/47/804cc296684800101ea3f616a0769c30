
#include "xparameters.h"
#include "xscugic.h"

#define INTC_DEVICE_ID  XPAR_PS7_SCUGIC_0_DEVICE_ID

#define CWT_DONE_INTR XPAR_FABRIC_TFX_CORE_0_CWT_DONE_INTR

SemaphoreHandle_t timerSemaphore;

static void CwtDoneHandler(XTtcPs *InstancePtr)
{
	BaseType_t xHigherPriorityTaskWoken = pdFALSE;
	u32 XTtcPsStatusReg;
	Xil_AssertNonvoid(InstancePtr != NULL);

	XTtcPsStatusReg = XTtcPs_GetInterruptStatus(InstancePtr);
	XTtcPs_ClearInterruptStatus(InstancePtr, XTtcPsStatusReg);
//	XTtcPs_Stop(InstancePtr);

	if ( xSemaphoreGiveFromISR( timerSemaphore, &xHigherPriorityTaskWoken ) != pdFALSE) {
		portYIELD_FROM_ISR( xHigherPriorityTaskWoken );
	}
}


int SetupInterruptSystem(XScuGic *IntcInstancePtr)
{
	// Register interrupt handler using FreeRTOS-aware function
	xPortInstallInterruptHandler(CWT_DONE_INTR, CwtDoneHandler, NULL);

	// Enable the interrupt line
	vPortEnableInterrupt(CWT_DONE_INTR);

	return XST_SUCCESS;
}

